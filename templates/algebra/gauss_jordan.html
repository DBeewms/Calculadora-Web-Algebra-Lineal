{% extends "algebra/base.html" %}
{% block title %}Gauss-Jordan{% endblock %}
{% block content %}
<h2>Gauss-Jordan (A|b)</h2>
<form method="post" class="matrix-form" data-mode="aug">{% csrf_token %}
  <div class="controls">
  <div class="control"><label>Ecuaciones</label><input type="number" min="1" value="2" data-target="rows"/></div>
  <div class="control"><label>Variables</label><input type="number" min="1" value="2" data-target="cols"/></div>
    <label class="toggle" id="toggle-steps-gj">
      <input type="checkbox" name="show_steps" checked>
      <span class="toggle-track"></span>
      <span class="toggle-thumb"></span>
      <span class="toggle-label">Mostrar pasos</span>
    </label>
    <div class="control">
      <label>Formato de resultado</label>
      <select name="result_format">
        <option value="frac" {% if result_format == 'frac' or not result_format %}selected{% endif %}>Fracciones exactas</option>
        <option value="dec" {% if result_format == 'dec' %}selected{% endif %}>Decimales</option>
        <option value="auto" {% if result_format == 'auto' %}selected{% endif %}>Automático (exacto si finito)</option>
      </select>
    </div>
    <div class="control" style="display:none">
      <label>Precisión (decimales)</label>
      <input type="number" name="precision" min="0" max="12" value="{{ precision|default:6 }}" />
    </div>
    <button type="button" class="btn" data-action="resize">Actualizar tamaño</button>
    <button type="button" class="btn ghost" data-action="open-eq">Ecuaciones…</button>
  </div>
  <div class="matrix-aug panel">
    <div class="matrix" data-name="matrizA"></div>
    <div class="aug-bar">|</div>
    <div class="matrix" data-name="vectorB" data-cols="1"></div>
    <input type="hidden" name="matrizA"/>
    <input type="hidden" name="vectorB"/>
    <input type="hidden" name="matrizAug"/>
    <input type="hidden" name="rows"/>
    <input type="hidden" name="cols"/>
  </div>
  {% include "algebra/_equations_toggle.html" %}
  <div class="actions">
    <button type="button" class="btn secondary" data-action="clear">Limpiar</button>
    <button type="button" class="btn ghost" data-action="example" data-example="aug">Ejemplo</button>
    <button type="submit" class="btn primary">Calcular</button>
  </div>
  {% if prefill %}<script id="prefillData" type="application/json">{{ prefill|safe }}</script>{% endif %}
</form>

{# Panel de error eliminado: SweetAlert maneja la notificación en base.html #}

{% if resultado and analisis %}
<section class="panel highlight">
  <div class="panel-header">
    <h3 class="panel-title">Resultado y análisis</h3>
    <div class="panel-actions">
      <span class="badge">Matriz de coeficientes A {{ dims.A }}</span>
      <span class="badge">Vector columna b {{ dims.b }}</span>
      <span class="badge">Forma escalonada reducida</span>
      {% if vars %}<span class="badge">Vars: {{ vars|join:', ' }}</span>{% endif %}
    </div>
  </div>
  <div class="panel-body">
  <!-- Etiquetas integradas en los badges superiores -->
    <div class="matrix-result">
      <table class="matriz">
        {% for fila in resultado %}
          <tr>{% for celda in fila %}<td><span>{{ celda }}</span></td>{% endfor %}</tr>
        {% endfor %}
      </table>
    </div>
    <hr style="margin:16px 0; border:none; border-top:1px solid var(--border)"/>
    <p><strong>Clasificación:</strong>
      {% if analisis.solucion == 'UNICA' %}<span class="tag success">Solución única</span>
      {% elif analisis.solucion == 'INFINITAS' %}<span class="tag info">Infinitas soluciones</span>
      {% else %}<span class="tag danger">Inconsistente</span>{% endif %}
    </p>
    {% if analisis.solucion != 'INCONSISTENTE' %}
    <p><strong>Columnas pivote:</strong>
      {% if analisis.pivotes_nums and analisis.pivotes_nums|length > 0 %}
        {% for num in analisis.pivotes_nums %}{{ num }}{% if not forloop.last %}, {% endif %}{% endfor %}
      {% else %}—{% endif %}
    </p>
    {% endif %}
    {% if analisis.solucion == 'UNICA' %}
      <div>
        <strong>Vector solución:</strong>
        <ul class="inline-cards">
          {% for linea in analisis.vector_solucion %}<li>{{ linea }}</li>{% endfor %}
        </ul>
      </div>
    {% elif analisis.solucion == 'INFINITAS' %}
      <div>
        <p><strong>Variables libres:</strong>
          {% if analisis.libres_detalle %}{% for linea in analisis.libres_detalle %}{{ linea }}{% if not forloop.last %}, {% endif %}{% endfor %}{% else %}—{% endif %}
        </p>
        <p><strong>Dependencias:</strong></p>
        <ul class="inline-cards">
          {% for ex in analisis.expresiones %}<li>{{ ex }}</li>{% endfor %}
        </ul>
        <p><em>Solución particular (parámetros = 0):</em></p>
        <ul class="inline-cards mini">
          {% for linea in analisis.vector_solucion %}<li>{{ linea }}</li>{% endfor %}
        </ul>
      </div>
    {% elif analisis.solucion == 'INCONSISTENTE' %}
      <p><strong>Inconsistencia:</strong> {{ analisis.detalle }}</p>
    {% endif %}
  </div>
</section>
{% endif %}

{% if pasos %}
<details open class="panel">
  <summary class="panel-title">Pasos del procedimiento</summary>
  <ol class="steps timeline">
    {% for p in pasos %}
      <li>
        <div class="step-title">{{ p.operacion }}</div>
        <div class="step-matrix">
          <table class="matriz mini">
            {% for fila in p.matriz %}
              <tr>{% for celda in fila %}<td><span>{{ celda }}</span></td>{% endfor %}</tr>
            {% endfor %}
          </table>
        </div>
      </li>
    {% endfor %}
  </ol>
</details>
{% endif %}
{% block extra_js %}
{% if resultado %}
<script>Swal.fire({icon:'success', title:'Gauss-Jordan completado', timer:1800, showConfirmButton:false});</script>
{% endif %}
{% endblock %}
{% endblock %}
