{% extends 'algebra/base.html' %}
{% load static %}
{% block title %}Límite — KiwiSolve{% endblock %}
{% block content %}
<h2>Límite</h2>
<p>Introduce la expresión (puedes usar LaTeX o escribirla directamente). Usa la variable <strong>x</strong> por defecto.</p>
<form method="post" class="panel" id="limiteForm">
  {% csrf_token %}
  <label for="expr_field">Expresión</label>
  <math-field id="expr_field" virtual-keyboard-mode="onfocus" placeholder="e.g. \frac{\sin(x)}{x}">{% if expr_used %}{{ expr_used }}{% endif %}</math-field>
  <input type="hidden" name="expr" id="expr_hidden" />
  <label for="var">Variable</label>
  <input id="var" name="var" value="{% if var %}{{ var }}{% else %}x{% endif %}" />
  <label for="point">Punto (lim x→a): escribe número, 'oo' para infinito</label>
  <input id="point" name="point" value="{% if point_used %}{{ point_used }}{% else %}0{% endif %}" />
  <label for="direction">Dirección</label>
  <select id="direction" name="direction">
    <option value="both" {% if direction_used == 'both' or not direction_used %}selected{% endif %}>Ambos</option>
    <option value="+" {% if direction_used == '+' %}selected{% endif %}>Derecha (+)</option>
    <option value="-" {% if direction_used == '-' %}selected{% endif %}>Izquierda (-)</option>
  </select>
  <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
    <button class="btn primary" type="submit">Calcular límite</button>
    <button type="button" id="limpiarBtn" class="btn ghost">Limpiar</button>
  </div>
</form>

{% if resultado is not None %}
  <h3>Resultado</h3>
  <div class="card vertical">
    <p><strong>Expresión normalizada:</strong> <code>{{ expr_used }}</code></p>
    <p><strong>Límite en x → {{ point_used }}{% if direction_used and direction_used != 'both' %} (desde {{ direction_used }}){% endif %}:</strong></p>
    <pre>{{ resultado }}</pre>
  </div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
(function(){
  const form = document.getElementById('limiteForm');
  const mf = document.getElementById('expr_field');
  const hidden = document.getElementById('expr_hidden');
  form.addEventListener('submit', function(ev){
    // Normalize LaTeX-style input to a JS-style expression using helpers in app.js
    try{
      let raw = '';
      if(mf && typeof mf.getValue === 'function'){
        raw = mf.getValue();
      } else if(mf && mf.value){
        raw = mf.value;
      } else if(mf && mf.textContent){
        raw = mf.textContent;
      }
      // Use latexToFunction and toJSExpr if available
      if(window.latexToFunction) raw = window.latexToFunction(raw);
      if(window.toJSExpr) raw = window.toJSExpr(raw);
      if(hidden) hidden.value = raw;
    }catch(e){
      // ignore, let server try to sympify raw latex
    }
  });

  // Limpiar control
  const limpiar = document.getElementById('limpiarBtn');
  if(limpiar){
    limpiar.addEventListener('click', ()=>{
      try{
        if(mf && typeof mf.setValue === 'function') mf.setValue('');
        else if(mf) mf.textContent = '';
        if(hidden) hidden.value = '';
        document.getElementById('var').value = 'x';
        document.getElementById('point').value = '0';
        document.getElementById('direction').value = 'both';
      }catch(_e){}
    });
  }
})();
</script>
{% endblock %}
