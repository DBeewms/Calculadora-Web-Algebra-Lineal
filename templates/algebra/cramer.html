{% extends "algebra/base.html" %}
{% block title %}Regla de Cramer{% endblock %}
{% block content %}
<h2>Regla de Cramer (Ax = b)</h2>
<form method="post" class="matrix-form" data-mode="cramer">{% csrf_token %}
  <div class="controls">
    <div class="control">
      <label>n (tamaño de A es n×n)</label>
      <input type="number" min="1" value="2" data-target="rowsAcolsArowsB"/>
    </div>
    <div class="control" style="display:none">
      <label>Columnas (b)</label>
      <input type="number" min="1" value="1" data-target="colsB"/>
    </div>
    <label class="toggle">
      <input type="checkbox" name="show_steps" checked>
      <span class="toggle-track"></span>
      <span class="toggle-thumb"></span>
      <span class="toggle-label">Mostrar pasos</span>
    </label>
    <div class="control">
      <label>Formato de resultado</label>
      <select name="result_format">
        <option value="frac" {% if result_format == 'frac' or not result_format %}selected{% endif %}>Fracciones exactas</option>
        <option value="dec" {% if result_format == 'dec' %}selected{% endif %}>Decimales</option>
        <option value="auto" {% if result_format == 'auto' %}selected{% endif %}>Automático (exacto si finito)</option>
      </select>
    </div>
    <div class="control" style="display:none">
      <label>Precisión (decimales)</label>
      <input type="number" name="precision" min="0" max="12" value="{{ precision|default:6 }}" />
    </div>
    <button type="button" class="btn" data-action="resize">Actualizar tamaño</button>
  </div>
  <div class="grid matrices panel">
    <div>
      <label>Matriz A (n×n)</label>
      <div class="matrix" data-name="matrizA"></div>
      <input type="hidden" name="matrizA"/>
    </div>
    <div>
      <label>Vector b (n×1)</label>
      <div class="matrix" data-name="vectorb" data-cols="1"></div>
      <input type="hidden" name="vectorb"/>
    </div>
  </div>
  <div class="actions">
    <button type="button" class="btn secondary" data-action="clear">Limpiar</button>
    <button type="button" class="btn ghost" data-action="example" data-example="cramer">Ejemplo</button>
    <button type="submit" class="btn primary">Resolver</button>
  </div>
</form>

{% if error %}<div class="alert-error">{{ error }}</div>{% endif %}

{% if resultado or no_invertible %}
<section class="panel">
  <div class="panel-header">
    <h3 class="panel-title">Resultado</h3>
    <div class="panel-actions">
      <span class="badge">A {{ dims.A }}</span>
      <span class="badge">b {{ dims.b }}</span>
      {% if invertible %}<span class="tag success">|A| ≠ 0 ⇒ A invertible</span>{% else %}<span class="tag danger">|A| = 0 ⇒ No invertible</span>{% endif %}
    </div>
  </div>
  <div class="panel-body">
    <p><strong>|A| =</strong> {{ detA }}</p>
    {% if no_invertible %}
      <p><strong>Mensaje:</strong> {{ no_invertible }}</p>
    {% endif %}
    {% if resultado %}
    <div class="matrix-result">
      <table class="matriz">
        {% for fila in resultado %}
          <tr>{% for celda in fila %}<td><span>{{ celda }}</span></td>{% endfor %}</tr>
        {% endfor %}
      </table>
    </div>
    <div style="margin-top:.5rem">
      <strong>Vector solución:</strong>
      <ul class="inline-cards">
        {% for linea in vector_solucion %}<li>{{ linea }}</li>{% endfor %}
      </ul>
    </div>
    {% if componentes %}
      <div class="muted small" style="margin-top:.75rem">
        {% for k,v in componentes.items %}
          <span class="badge">|{{ k }}| = {{ v }}</span>
        {% endfor %}
      </div>
    {% endif %}
    {% endif %}
  </div>
</section>
{% endif %}

{% if pasos %}
<details open class="panel">
  <summary class="panel-title">Pasos de Cramer</summary>
  <ol class="steps timeline cramer-steps">
    {% for p in pasos %}
      <li>
        <div class="step-title">{{ p.operacion }}</div>
        <div class="step-matrix">
          <table class="matriz mini">
            {% for fila in p.matriz %}
              <tr>{% for celda in fila %}<td><span>{{ celda }}</span></td>{% endfor %}</tr>
            {% endfor %}
          </table>
        </div>
      </li>
    {% endfor %}
  </ol>
</details>
{% endif %}
{% block extra_js %}
<script>
  // Fuerza vector b a n×1 enlazando controles: rowsAcolsArowsB define n; colsB=1 oculto.
  document.addEventListener('DOMContentLoaded', function(){
    const form = document.querySelector('form.matrix-form[data-mode="cramer"]');
    if(!form) return;
    const nCtl = form.querySelector('[data-target="rowsAcolsArowsB"]');
    const colsB = form.querySelector('[data-target="colsB"]');
    const resizeBtn = form.querySelector('[data-action="resize"]');
    function sync(){ if(colsB){ colsB.value='1'; colsB.setAttribute('readonly','readonly'); colsB.disabled=true; } resizeBtn?.click(); }
    nCtl?.addEventListener('change', sync); nCtl?.addEventListener('input', ()=>{});
    sync();
  });
</script>
{% if error %}
<script>Swal.fire({icon:'error', title:'Error', text:'{{ error|escapejs }}'});</script>
{% elif resultado %}
<script>Swal.fire({icon:'success', title:'Sistema resuelto (Cramer)', timer:1800, showConfirmButton:false});</script>
{% elif no_invertible %}
<script>Swal.fire({icon:'info', title:'|A| = 0', text:'{{ no_invertible|escapejs }}'});</script>
{% endif %}
{% endblock %}
{% endblock %}
