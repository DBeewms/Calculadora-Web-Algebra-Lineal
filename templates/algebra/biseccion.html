{% extends "algebra/base.html" %}
{% block title %}Método de bisección — KiwiSolve{% endblock %}
{% block content %}
<section class="section">
  <h2>{{ title }}</h2>

  <form method="post" class="panel matrix-form" style="padding:16px;" data-page="biseccion">
    {% csrf_token %}
    <div class="grid">
      <div class="control">
  <label>Ecuación igualada a 0</label>
        <math-field class="mf" id="mf-function" virtualkeyboardmode="onfocus" virtualkeyboardtogglevisible="false"
          placeholder="Ej: x^3 - x - 1 = 0">{{ function|default:'' }}</math-field>
        <input type="hidden" name="function" id="hid-function" value="{{ function|default:'' }}" />
        <div id="biseccion-preview" style="margin-top:6px; font-size:13px;">
          <div id="biseccion-preview-ok" style="color:var(--muted); display:none;">Previsualización: f(x) = <code id="biseccion-preview-text"></code></div>
          <div id="biseccion-preview-err" style="color:#b91c1c; display:none;">Error: <span id="biseccion-preview-err-txt"></span></div>
        </div>
        <div class="mini-toolbar" style="margin-top:6px; display:flex; gap:6px; align-items:center; font-size:13px; color:var(--muted);">
          <span>Atajos:</span>
          <button type="button" class="btn ghost" data-action="insert-sqrt" title="Insertar raíz cuadrada" style="padding:2px 6px; font-size:12px;">√{ }</button>
          <button type="button" class="btn ghost" data-action="insert-nthroot" title="Insertar raíz n-ésima" style="padding:2px 6px; font-size:12px;">ⁿ√{ }</button>
          <span style="margin-left:6px;">Tip: también puedes escribir <code>\sqrt[n]{...}</code></span>
        </div>
      </div>
      <div class="control">
        <label>a (extremo izquierdo)</label>
  <math-field class="mf" id="mf-a" virtualkeyboardmode="onfocus" virtualkeyboardtogglevisible="false" placeholder="Ej: 1">{{ a_input|default:'' }}</math-field>
  <input type="hidden" name="a" id="hid-a" value="{{ a_input|default:'' }}" />
      </div>
      <div class="control">
        <label>b (extremo derecho)</label>
  <math-field class="mf" id="mf-b" virtualkeyboardmode="onfocus" virtualkeyboardtogglevisible="false" placeholder="Ej: 2">{{ b_input|default:'' }}</math-field>
  <input type="hidden" name="b" id="hid-b" value="{{ b_input|default:'' }}" />
      </div>
      <div class="control">
        <label>Tolerancia ε</label>
  <math-field class="mf" id="mf-tol" virtualkeyboardmode="onfocus" virtualkeyboardtogglevisible="false" placeholder="Ej: 1e-6">{{ tol_input|default:'' }}</math-field>
  <input type="hidden" name="tol" id="hid-tol" value="{{ tol_input|default:'' }}" />
      </div>
      <div class="control">
        <label>Max iteraciones</label>
  <math-field class="mf" id="mf-maxit" virtualkeyboardmode="onfocus" virtualkeyboardtogglevisible="false" placeholder="Ej: 100">{{ maxit_input|default:'' }}</math-field>
  <input type="hidden" name="maxit" id="hid-maxit" value="{{ maxit_input|default:'' }}" />
      </div>
    </div>
    <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
      <button type="submit" class="btn">Calcular</button>
      <button type="button" class="btn secondary" data-action="plot-func" aria-label="Graficar función">Graficar función</button>
      <button type="button" class="btn ghost" data-action="clear" aria-label="Limpiar formulario">Limpiar</button>
    </div>
  </form>

  <!-- Panel de previsualización (cliente) -->
  <section id="biseccionPreviewPanel" class="panel" style="margin-top:12px; display:none;">
    <div class="panel-header">
      <h3 class="panel-title">Previsualización de f(x)</h3>
      <div class="panel-actions">
        <span class="badge">Solo función</span>
      </div>
    </div>
    <div id="plotBiseccionPreview" style="width:100%; height:360px;"></div>
  </section>

  {# Paneles de error/mensaje eliminados: se usan SweetAlert en base.html #}

  {% if plot %}
  <section class="panel" style="margin-top:12px;">
    <div class="panel-header">
      <h3 class="panel-title">Gráfica de f(x) en [a, b]</h3>
      <div class="panel-actions">
        <span class="badge">Intervalo: [{{ a_input }}, {{ b_input }}]</span>
      </div>
    </div>
    <div id="plotBiseccion" style="width:100%; height:360px;"></div>
    <script id="plotData" type="application/json">{{ plot|safe }}</script>
  </section>
  {% endif %}

  {% if iteraciones %}
    <div class="panel" style="margin-top:12px; padding:12px; overflow:auto;">
      <h3>Tabla de iteraciones</h3>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="border:1px solid var(--border); padding:8px;">i</th>
            <th style="border:1px solid var(--border); padding:8px;">a</th>
            <th style="border:1px solid var(--border); padding:8px;">b</th>
            {% with request.resolver_match.url_name as url_name %}
            <th style="border:1px solid var(--border); padding:8px;">{% if url_name == 'regula_falsi' %}c{% else %}c = (a+b)/2{% endif %}</th>
            {% endwith %}
            <th style="border:1px solid var(--border); padding:8px;">f(a)</th>
            <th style="border:1px solid var(--border); padding:8px;">f(b)</th>
            <th style="border:1px solid var(--border); padding:8px;">f(c)</th>
            <th style="border:1px solid var(--border); padding:8px;">Actualización</th>
          </tr>
        </thead>
        <tbody>
          {% for it in iteraciones %}
          <tr>
            <td style="border:1px solid var(--border); padding:6px; text-align:center;">{{ it.i }}</td>
            <td style="border:1px solid var(--border); padding:6px;">{{ it.a }}</td>
            <td style="border:1px solid var(--border); padding:6px;">{{ it.b }}</td>
            <td style="border:1px solid var(--border); padding:6px;">{{ it.c }}</td>
            <td style="border:1px solid var(--border); padding:6px;">{{ it.fa }}</td>
            <td style="border:1px solid var(--border); padding:6px;">{{ it.fb }}</td>
            <td style="border:1px solid var(--border); padding:6px;">{{ it.fc }}</td>
            <td style="border:1px solid var(--border); padding:6px; text-align:center;">{{ it.actualizacion }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <h4 style="margin-top:12px;">Resumen</h4>
      {% if convergio %}
        <p>El método converge en la iteración {{ conteo_iter }}</p>
      {% else %}
        <p>El método no converge en {{ conteo_iter }} iteraciones</p>
      {% endif %}

      <p>La raíz aproximada (c) es {{ raiz }}</p>
      <p>El error es f(c) = {{ f_en_raiz }}</p>
    </div>
  {% endif %}

</section>
{% endblock %}
{% block extra_js %}
{% if plot %}
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script>
  (function(){
    const el = document.getElementById('plotBiseccion');
    const payloadEl = document.getElementById('plotData');
    if(!el || !payloadEl) return;
    let data = null; try{ data = JSON.parse(payloadEl.textContent||''); }catch(e){ data = null; }
    if(!data) return;
    const styles = getComputedStyle(document.documentElement);
    const primary = (styles.getPropertyValue('--primary')||'#7E57C2').trim();
    const accent = (styles.getPropertyValue('--sky')||'#7BBBC4').trim();
    const muted = (styles.getPropertyValue('--muted')||'#6b7280').trim();
    const border = (styles.getPropertyValue('--border')||'#e3e5f0').trim();
    const card = (styles.getPropertyValue('--card')||'#ffffff').trim();
    const bg = (styles.getPropertyValue('--bg')||'#f6f7fb').trim();

    const xs = data.xs||[];
    const ys = data.ys||[];
    const a = data.a; const b = data.b;
    const fa = data.fa; const fb = data.fb;
    const xmin = Math.min.apply(null, xs);
    const xmax = Math.max.apply(null, xs);
    const pad = (xmax - xmin) * 0.04;
    // Calcular rango Y válido ignorando valores nulos o no finitos
    const yValid = ys.filter(v => typeof v === 'number' && isFinite(v));
    let ymin = (yValid.length ? Math.min.apply(null, yValid) : -1);
    let ymax = (yValid.length ? Math.max.apply(null, yValid) : 1);
    if(ymax - ymin < 1e-9){ ymin -= 1; ymax += 1; }
    const ypad = (ymax - ymin) * 0.06;

    const traceFunc = {
      x: xs, y: ys, mode: 'lines', name: 'f(x)',
      line: { color: primary, width: 2.5 }, hovertemplate: 'x=%{x:.6f}<br>f(x)=%{y:.6f}<extra></extra>'
    };
    const traceAB = {
      x: [a, b], y: [fa, fb], mode: 'markers+text', name: 'Extremos (a, b)',
      text: ['a','b'], textposition: 'top center',
      marker: { color: accent, size: 9, line: { color: '#fff', width: 1.5 } }, hovertemplate: '(%{x:.6f}, %{y:.6f})<extra></extra>'
    };
    const traceAxis = {
      x: [xmin, xmax], y: [0, 0], mode: 'lines', name: 'y = 0',
      line: { color: muted, dash: 'dot', width: 1.5 }, hoverinfo: 'skip'
    };
    // Eje Y (x = 0)
    const traceAxisY = {
      x: [0, 0], y: [ymin - ypad, ymax + ypad], mode: 'lines', name: 'x = 0',
      line: { color: muted, dash: 'dot', width: 1.5 }, hoverinfo: 'skip'
    };

    const layout = {
      margin: { l: 50, r: 20, t: 10, b: 40 },
      paper_bgcolor: card,
      plot_bgcolor: card,
      hovermode: 'closest',
      showlegend: true,
      dragmode: 'pan',
      xaxis: {
        title: 'x',
        gridcolor: border, zerolinecolor: border,
        range: [xmin - pad, xmax + pad],
        rangeslider: { visible: true }
      },
      yaxis: { title: 'f(x)', gridcolor: border, zerolinecolor: border, range: [ymin - ypad, ymax + ypad] },
      legend: { orientation: 'h', x: 0, y: 1.1 },
      uirevision: 'biseccion-plot'
    };

    Plotly.newPlot(el, [traceFunc, traceAxis, traceAxisY, traceAB], layout, {
      displayModeBar: true,
      responsive: true,
      scrollZoom: true,
      doubleClick: 'reset'
    });

    // Dynamic resampling on pan/zoom to avoid cut-offs and allow exploring more quadrants
    try{
      const hidFn = document.getElementById('hid-function');
      const exprRaw = (hidFn?.value || '').trim();
      if(exprRaw && window.toJSExpr){
        const exprJS = window.toJSExpr(exprRaw);
        const forbidden = /(constructor|prototype|__proto__|=>|new\s+Function|Function\s*\()/;
        function safeEvalFunc(x){
          if(forbidden.test(exprJS)) return null;
          // eslint-disable-next-line no-new-func
          const fn = new Function('Math','x', 'return ( ' + exprJS + ' )');
          let y = null;
          try{ y = fn(Math, x); }catch(_e){ y = null; }
          if(typeof y !== 'number' || !isFinite(y)) return null;
          return y;
        }

        // Debounce relayout events
        let relayoutTimer = null;
        function resampleForRange(x0, x1){
          if(!(isFinite(x0) && isFinite(x1)) || x0 === x1) return;
          // Choose sample count based on pixel width for good density
          const width = el.clientWidth || 800;
          const n = Math.max(300, Math.min(1600, Math.floor(width * 1.5)));
          const xs2 = new Array(n);
          const ys2 = new Array(n);
          const xa = Math.min(x0, x1), xb = Math.max(x0, x1);
          for(let i=0;i<n;i++){
            const t = i/(n-1);
            const x = xa + (xb - xa) * t;
            xs2[i] = +x.toFixed(6);
            const y = safeEvalFunc(x);
            ys2[i] = (y==null || !isFinite(y)) ? null : +y.toFixed(12);
          }
          // Update trace 0 (function) efficiently
          Plotly.restyle(el, { x: [xs2], y: [ys2] }, [0]);
          // Recompute y-range from valid points in view
          const yValid = ys2.filter(v => typeof v === 'number' && isFinite(v));
          if(yValid.length){
            let ymin2 = Math.min.apply(null, yValid);
            let ymax2 = Math.max.apply(null, yValid);
            if(ymax2 - ymin2 < 1e-9){ ymin2 -= 1; ymax2 += 1; }
            const ypad2 = (ymax2 - ymin2) * 0.06;
            Plotly.relayout(el, { 'yaxis.range': [ymin2 - ypad2, ymax2 + ypad2] });
          }
        }

        el.on('plotly_relayout', (ev)=>{
          // Get new x range
          if(relayoutTimer) window.clearTimeout(relayoutTimer);
          relayoutTimer = window.setTimeout(()=>{
            let x0 = null, x1 = null;
            if(ev && typeof ev === 'object'){
              if('xaxis.range[0]' in ev && 'xaxis.range[1]' in ev){
                x0 = Number(ev['xaxis.range[0]']);
                x1 = Number(ev['xaxis.range[1]']);
              } else if('xaxis.autorange' in ev){
                // On autorange reset, fetch current axis range from layout
                const xr = el.layout?.xaxis?.range;
                if(Array.isArray(xr) && xr.length === 2){ x0 = xr[0]; x1 = xr[1]; }
              }
            }
            if(x0 == null || x1 == null){
              const xr = el.layout?.xaxis?.range;
              if(Array.isArray(xr) && xr.length === 2){ x0 = xr[0]; x1 = xr[1]; }
            }
            if(x0 != null && x1 != null) resampleForRange(x0, x1);
          }, 120);
        });
      }
    }catch(_e){ /* ignore dynamic resampling errors to keep plot usable */ }
  })();
  </script>
{% endif %}
{% endblock %}
